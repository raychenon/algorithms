# Java Gradle CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-java/ for more details
#
version: 2.1
jobs:
  build:
    working_directory: ~/algorithms
    docker:
      - image: circleci/openjdk:8-jdk

    environment:
      # Customize the JVM maximum heap limit
      JVM_OPTS: -Xmx3200m
      TERM: dumb
    orbs:
      codecov: codecov/codecov@1.0.5
    commands:
      upload:
        parameters:
          conf:
            description: Used to specify the location of the .codecov.yml config file
            type: string
            default: ".codecov.yml"
          file:
            description: Path to the code coverage data file to upload.
            type: string
            default: ""
          flags:
            description: Flag the upload to group coverage metrics (e.g. unittests | integration | ui,chrome)
            type: string
            default: ""
          token:
            description: Set the private repository token (defaults to environment variable $CODECOV_TOKEN)
            type: string
            default: ${CODECOV_TOKEN}
          upload_name:
            description: Custom defined name of the upload. Visible in Codecov UI
            type: string
            default: ${CIRCLE_BUILD_NUM}
          when:
            description: When should this step run?
            type: string
            default: "always"
    steps:
      - checkout

      # Download and cache dependencies
      - restore_cache:
          keys:
          - v1-dependencies-{{ checksum "build.gradle" }}
          # fallback to using the latest cache if no exact match is found
          - v1-dependencies-

      - run: gradle dependencies

      - save_cache:
          paths:
            - ~/.gradle
          key: v1-dependencies-{{ checksum "build.gradle" }}

      # run tests!
      - run: gradle check
      - run: gradle test
      # run coverage report
      - run: gradle jacocoTestReport
      - run:
          name: Upload Coverage Results
          command: |
            curl -s https://codecov.io/bash | bash -s -- \
              -t "<< parameters.token >>" \
              -n "<< parameters.upload_name >>" \
              -y "<< parameters.conf >>" \
              -F "<< parameters.flags >>" \
              -Z || echo 'Codecov upload failed'
            when: << parameters.when >>
